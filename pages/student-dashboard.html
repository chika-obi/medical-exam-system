<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Dashboard | MedExam System</title>
<style>
  body { font-family: "Segoe UI", Tahoma, sans-serif; margin:0; padding:0; background:#f4f7fb; color:#222; }
  header { background:#0d47a1; color:#fff; padding:16px 24px; display:flex; justify-content:space-between; align-items:center; }
  header h1 { margin:0; font-size:1.5rem; }
  .container { width:90%; max-width:1200px; margin:24px auto; display:grid; grid-template-columns:1fr 1fr; gap:24px; }

  .card { background:#fff; padding:20px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.08); }
  .card h2 { margin-top:0; color:#0d47a1; }
  .stats { display:flex; gap:16px; flex-wrap:wrap; }
  .stat-item { flex:1; background:linear-gradient(145deg, #0fa3a3, #2e7d32); color:#fff; padding:16px; border-radius:12px; text-align:center; box-shadow:0 6px 20px rgba(0,0,0,0.05); }
  .stat-item h3 { margin:0; font-size:1.5rem; }
  .stat-item p { margin:4px 0 0; font-size:0.9rem; }

  .exam-list { display:flex; flex-direction:column; gap:12px; }
  .exam-item { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:#e0f7fa; border-radius:8px; cursor:pointer; transition:all 0.2s; }
  .exam-item:hover { background:#b2ebf2; }
  .exam-item button { background:#0d47a1; color:#fff; border:none; border-radius:6px; padding:6px 12px; cursor:pointer; }

  .recent-exams { max-height:300px; overflow-y:auto; margin-top:12px; }
  .recent-item { padding:12px; background:#f4f7fb; border-radius:8px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 4px 16px rgba(0,0,0,0.03); }
  .recent-item span { font-weight:600; }
  .recent-item button { margin-left:8px; background:#0d47a1; color:#fff; border:none; border-radius:6px; padding:4px 8px; cursor:pointer; font-size:0.8rem; }

  /* Certificate Modal */
  #certModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:9999; }
  
  
  #certContent { 
    background:#fff; 
    padding:16px; 
    border-radius:12px; 
    text-align:center; 
    max-width:1024px; 
    width:90%; 
    max-height:90vh;      /* <-- add this line */
    overflow-y:auto;      /* <-- add this line */
}


  #certCanvas { width:100%; border:2px solid #0d47a1; border-radius:12px; }
  #certActions { margin-top:12px; display:flex; justify-content:center; gap:12px; }
  .btn { padding:8px 16px; border-radius:6px; border:none; cursor:pointer; font-weight:600; }
  .btn.primary { background:#0d47a1; color:#fff; }
  .btn.secondary { background:#d32f2f;color:#fff; }
</style>
</head>
<body>

<header>
  <h1>MedExam Student Dashboard</h1>
  <div style="display:flex;align-items:center;gap:16px;">
    <div id="studentName">Student</div>
    <button id="logoutBtn" class="btn secondary">Logout</button>
  </div>
</header>

<div class="container">
  <!-- Stats -->
  <div class="card">
    <h2>My Statistics</h2>
    <div class="stats">
      <div class="stat-item">
        <h3 id="totalExams">0</h3>
        <p>Total Exams Taken</p>
      </div>
      <div class="stat-item">
        <h3 id="avgScore">0%</h3>
        <p>Average Score</p>
      </div>
      <div class="stat-item">
        <h3 id="bestScore">0%</h3>
        <p>Best Score</p>
      </div>
    </div>
  </div>

  <!-- Exam List and Recent Results -->
  <div class="card">
    <h2>Available Exams</h2>
    <div class="exam-list" id="examList"></div>
    <h2 style="margin-top:24px">Recent Results</h2>
    <div class="recent-exams" id="recentResults"></div>
  </div>
</div>

<!-- Certificate Preview Modal -->
<div id="certModal">
  <div id="certContent">
    <canvas id="certCanvas" width="1000" height="700"></canvas>
    <div id="certActions">
      <button class="btn primary" id="downloadCertBtn">Download</button>
      <button class="btn secondary" id="closeCertBtn">Close</button>
    </div>
  </div>
</div>

<script>
(function(){
  const KEY = { QUESTIONS:'questions', RESULTS:'examResults' };
  const $ = s=>document.querySelector(s);
  const user = JSON.parse(localStorage.getItem('loggedInUser')||'{"fullname":"Student User","email":"student@example.com"}');
  $('#studentName').textContent = user.fullname || user.email;

  function loadQuestions(){ return JSON.parse(localStorage.getItem(KEY.QUESTIONS)||'[]'); }
  

  function loadResults(){
    const allResults = JSON.parse(localStorage.getItem(KEY.RESULTS) || '[]');
    if(!user || !user.email) return [];  // safety check
    // Filter only results for logged-in student
    return allResults.filter(r => r.studentEmail === user.email);
}
  function renderStats(){
    const results=loadResults();
    const total=results.length;
    const avg=total?Math.round(results.reduce((a,b)=>a+b.score,0)/total):0;
    const best=total?Math.max(...results.map(r=>r.score)):0;
    $('#totalExams').textContent=total;
    $('#avgScore').textContent=avg+'%';
    $('#bestScore').textContent=best+'%';
  }

  function renderExamList(){
    const questions=loadQuestions();
    const titles=[...new Set(questions.map(q=>q.examTitle||q.category||'Default Exam'))];
    const container=$('#examList'); container.innerHTML='';
    titles.forEach(title=>{
      const div=document.createElement('div'); div.className='exam-item';
      div.innerHTML=`<span>${title}</span>`;
      const btn=document.createElement('button'); btn.textContent='Take Exam';
      btn.addEventListener('click',()=>window.location.href=`../pages/exam.html?examTitle=${encodeURIComponent(title)}`);
      div.appendChild(btn);
      container.appendChild(div);
    });
  }

  function renderRecentResults(){
    const results=loadResults().sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));
    const container=$('#recentResults'); container.innerHTML='';
    results.slice(0,5).forEach(r=>{
      const div=document.createElement('div'); div.className='recent-item';
      const titleSpan = document.createElement('span'); titleSpan.textContent = `${r.examTitle} - ${r.score}%`;
      div.appendChild(titleSpan);

      const previewBtn = document.createElement('button'); 
      previewBtn.textContent = 'Preview Certificate';
      previewBtn.addEventListener('click',()=>previewCertificate(r));
      div.appendChild(previewBtn);

      container.appendChild(div);
    });
  }

  // Certificate Preview
  const certModal = $('#certModal');
  const certCanvas = $('#certCanvas');
  const ctx = certCanvas.getContext('2d');
  const downloadBtn = $('#downloadCertBtn');
  const closeBtn = $('#closeCertBtn');

  function previewCertificate(result){
    certModal.style.display='flex';

    // Background gradient
    const grd = ctx.createLinearGradient(0,0,0,certCanvas.height);
    grd.addColorStop(0,'#0fa3a3'); grd.addColorStop(1,'#0d47a1');
    ctx.fillStyle = grd;
    ctx.fillRect(0,0,certCanvas.width,certCanvas.height);

    // White content panel
    ctx.fillStyle = '#fff';
    ctx.fillRect(50,50,certCanvas.width-100,certCanvas.height-100);

    // Border
    ctx.strokeStyle = '#0d47a1';
    ctx.lineWidth = 6;
    ctx.strokeRect(50,50,certCanvas.width-100,certCanvas.height-100);

    // Certificate text
    ctx.fillStyle = '#0d47a1';
    ctx.font = 'bold 48px Segoe UI';
    ctx.textAlign = 'center';
    ctx.fillText('Certificate of Completion', certCanvas.width/2, 150);

    ctx.fillStyle = '#2e7d32';
    ctx.font = 'bold 36px Segoe UI';
    ctx.fillText(result.studentName || user.fullname, certCanvas.width/2, 250);

    ctx.fillStyle = '#444';
    ctx.font = '24px Segoe UI';
    ctx.fillText(`has successfully completed the exam: ${result.examTitle}`, certCanvas.width/2, 320);
    ctx.fillText(`Score: ${result.score}%`, certCanvas.width/2, 360);
    ctx.fillText(`Date: ${new Date(result.timestamp).toLocaleDateString()}`, certCanvas.width/2, 400);

    // Signatories
    ctx.font = '20px Segoe UI';
    ctx.fillStyle = '#0d47a1';
    ctx.fillText('Lead Trainer', certCanvas.width/4, 600);
    ctx.fillText('Chief Medical Officer', certCanvas.width/1.33, 600);

    ctx.strokeStyle = '#0d47a1';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(120,620); ctx.lineTo(320,620); ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(680,620); ctx.lineTo(880,620); ctx.stroke();

    // Logo optional
    const logo = new Image();
    logo.src = './assets/images/medex_logo_3.png';
    logo.onload = ()=>ctx.drawImage(logo, certCanvas.width-200, 60, 120, 120);
  }

  downloadBtn.addEventListener('click', ()=>{
    const dataURL = certCanvas.toDataURL('image/png');
    const link = document.createElement('a');
    link.href = dataURL;
    link.download = `Certificate_${user.fullname}.png`;
    link.click();
  });

  closeBtn.addEventListener('click', ()=>{ certModal.style.display='none'; });

  $('#logoutBtn').addEventListener('click', ()=>{
    if(confirm('Are you sure you want to logout?')){
      localStorage.removeItem('loggedInUser');
      window.location.href='../pages/login.html';
    }
  });

  function init(){
    renderStats();
    renderExamList();
    renderRecentResults();
  }
  setInterval(init,2000);
  init();
})();
</script>
</body>
</html>
